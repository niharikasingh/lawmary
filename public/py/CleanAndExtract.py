from nltk.stem.porter import *
import nltk.data
import warnings
import networkx as nx
import math
import itertools
import logging, sys
import warnings

#set up logging
logging.basicConfig(stream=sys.stderr, level=logging.ERROR)

#silence warnings
warnings.filterwarnings("ignore", "zero out")

#get stopwords
sw = set()
with open('public/py/english', 'r') as stopfile:
    for line in stopfile:
        sw.add(line[:-1])
for i in range(97, 123):
    sw.add(chr(i))

def calculateDistance(firstString, secondString):
    fs = firstString.replace('.', '')
    ss = secondString.replace('.', '')
    fs = fs.split(" ")
    ss = ss.split(" ")
    fs = [e for e in fs if e not in sw]
    ss = [e for e in ss if e not in sw]
    stemmer = PorterStemmer()
    fs = [stemmer.stem(e) for e in fs]
    ss = [stemmer.stem(e) for e in ss]
    commonWords = set(fs) & set(ss)
    commonWords = len(commonWords)
    logging.debug("sentenceA: {} \n sentenceB: {}".format(fs, ss))
    normalize = math.ceil(math.log(len(fs)) + math.log(len(ss)))
    if (normalize > 0):
        return commonWords/normalize
    return 0

def buildGraph(nodes):
    gr = nx.Graph() #initialize an undirected graph
    gr.add_nodes_from(nodes)
    nodePairs = list(itertools.combinations(nodes, 2))

    #add edges to the graph (weighted by Levenshtein distance)
    for pair in nodePairs:
        firstString = pair[0]
        secondString = pair[1]
        distance = calculateDistance(firstString, secondString)
        gr.add_edge(firstString, secondString, weight=distance)

    return gr

def clean(text):
    #remove newlines
    re.sub(r'\n', '', text)
    #split into sentences
    tokenizer = nltk.data.load('public/py/english.pickle')
    sentences = tokenizer.tokenize(text)
    for i in range(len(sentences)-1, -1, -1):
        currS = sentences[i]
        #remove material in square brackets
        currS = re.sub(r'\[\d.*?\]', '', currS)
        #remove footnotes after periods, commas
        currS = re.sub(r'([\.,;"a-z])([1-9][0-9]?)( )', r'\1 ', currS)
        #roll up weird endings - check if abbreviation by checking if last word in sentence has an upper case first letter
        currSWords = currS.replace('.', '')
        currSWords = currSWords.split(" ")
        lastWord = currSWords[-1]
        if (i+1 < len(sentences)) and (((len(lastWord) > 0) and (u'A' <= lastWord[0] <= u'Z')) or (currS[-3:]==u'pp.') or (currS[-3:]==u'no.')):
            logging.debug('clean Function:\t joined improperly split sentence {}'.format(currS.encode("utf8")))
            currS += ( u' ' + sentences[i+1] )
            sentences[i+1] = u''
            sentences[i] = currS
        #roll up weird endings - check if abbreviation by checking if first letter of current sentence is lower case
        elif ((i-1 >= 0) and (len(currS) > 0) and ((u'a' <= currS[0] <= u'z') or (u'0' <= currS[0] <= u'9'))):
            sentences[i-1] += ( u' ' + currS )
            sentences[i] = u''
        else:
            sentences[i] = currS
    sentences = [s for s in sentences if len(s) > 0]
    return sentences

def soOrdered(impSentences, sentences):
    summary = u'\n'.join(impSentences)
    logging.debug('Type of summary output is {}'.format(type(summary)))
    #add last sentence after making sure it is not "it is so ordered"
    if (len(sentences) >= 1) and (sentences[-1] not in summary) and ("order" not in sentences[-1].lower()):
        summary += (u'\n' + sentences[-1])
    if (len(sentences) >= 2) and (sentences[-2] not in summary) and ("order" in sentences[-1].lower()):
        summary += (u'\n' + sentences[-2])
    return summary

def extractSentences(text, ratio):
    ratio = float(ratio)
    sentences = clean(text)
    if (len(sentences) <= 10):
        return sentences
    targetLength = int(math.ceil(ratio*len(sentences)))
    graph = buildGraph(sentences)
    calculated_page_rank = nx.pagerank(graph, weight='weight')

    #most important sentences in ascending order of importance
    importantSentences = sorted(calculated_page_rank, key=calculated_page_rank.get, reverse=True)[:targetLength]
    
    #most important sentences in ascending order of appearance in original
    sortedImportantSentences = [s for s in sentences if s in importantSentences]
    
    summary = soOrdered(sortedImportantSentences, sentences)

    print(summary)
    return summary

#main function runs script
def main(args):
    logging.debug('Arguments are: {} {}'.format(args[1], args[2]))
    return extractSentences(args[1], args[2])
    #test = """453 F.3d 396    JAMES CAPE &amp; SONS COMPANY, Plaintiff-Appellant,v.PCC CONSTRUCTION COMPANY (f/k/a Streu Construction Company), Vinton Construction Company, John Streu, Ernest J. Streu, James J. Maples, Michael J. Maples and Daniel Beaudoin, Defendants-Appellees.    No. 05-3894.    United States Court of Appeals, Seventh Circuit.    Argued June 1, 2006.    Decided June 28, 2006.          Matthew J. Flynn (argued), Quarles &amp; Brady, Milwaukee, WI, for Plaintiff-Appellant.      Andrew W. Erlandson (argued), Hurley, Burish &amp; Milliken, Madison, WI, Michael B. Apfeld (argued), Daniel T. Flaherty, Godfrey &amp; Kahn, Kathryn A. Keppel, Gimbel, Reilly, Guerin &amp; Brown, Milwaukee, WI, for Defendants-Appellees.      Before FLAUM, Chief Judge, and MANION and WILLIAMS, Circuit Judges.      FLAUM, Chief Judge.              1      Defendants pleaded guilty to rigging bids for State of Wisconsin Department of Transportation construction projects. One of the defendants, Daniel Beaudoin, is a former employee of James Cape &amp; Sons (\"Cape\"), the plaintiff construction company. Plaintiff alleges that with Beaudoin's help, the defendant construction companies learned of Cape's bids for various construction projects, which is forbidden in Wisconsin's blind bidding process. This knowledge allegedly allowed them to unfairly manipulate the bidding process by underbidding Cape by small increments. Cape filed an antitrust and a civil RICO suit against the defendants. The district court dismissed the case on the pleadings. Cape appeals. For the following reasons, we now affirm.        I. Background          2      PCC Construction Co., f/k/a Streu Construction Co. (\"Streu\"), Vinton Construction Co. (\"Vinton\"), the owners of those companies, and Daniel Beaudoin are the defendants in this action. They have plead guilty to collaborating to rig bids for construction projects for, among others, the State of Wisconsin Department of Transportation (\"WisDOT\"). WisDOT allocates construction projects through a closed bidding system. WisDOT is required by law to accept the lowest bid from a \"competent and eligible bidder.\" In order to be \"eligible,\" a bidder must submit a sworn statement that the bidder did not collude with competitors or otherwise restrain free bidding.              3      Beginning in approximately 1997 and continuing until 2004, the defendants began to unfairly rig the WisDOT bidding process. The owners of Streu and Vinton would meet to discuss projects that would soon be up for bid. They would share their companies' bid information, discuss potential competitors, and set bids amongst themselves in an attempt to allocate projects between them.              4      In late 1996, John Streu of Streu Construction Co. approached defendant Beaudoin and asked him to become part of the bid-rigging scheme. At that time, Beaudoin was an area manager for Cape, and as part of his job, he worked on Cape's bids before they were submitted to WisDOT. Through a series of in-person and telephonic meetings, Beaudoin shared Cape's confidential information with the other defendants, sometimes mere minutes before the companies submitted their bids. This allowed the conspirators to lower or raise their bids to just under the amount that Cape was going to bid.              5      In 2003, another Cape employee began to suspect that Beaudoin might be revealing confidential bid information to competitors. In March 2003, Plaintiff reported its suspicions about Beaudoin to the United State's Attorney's Office for the Eastern District of Wisconsin. Beaudoin eventually cooperated with the government in its investigation of the bid-rigging scheme.              6      Cape alleges that because Streu and Vinton were able to inflate their bids on contracts that they were sure they would receive, WisDOT was overcharged by almost two million dollars over the life of the scheme. Cape also alleges that it lost millions of dollars of business because its share of the market was reduced and it was awarded fewer contracts than it otherwise would have been.              7      Defendants Ernest Streu, John Streu, James Maples, and Michael Maples all pleaded guilty to antitrust violations, and admitted that they met in person and \"allocate[d] upcoming construction projects among themselves and [] arrange[d] for each other to submit complementary bids for or refrain from bidding on particular projects.\" Beaudoin also pleaded guilty, stating that he and his co-conspirators \"would cause rigged bids to be submitted from the offices of Vinton and Streu . . . and from Cape's offices in Racine County to WisDOT and other entities,\" and that, \"[d]uring [his] participation in these activities, his employer received contracts totaling in excess of $17.1 million for projects which had been the subject of the conspiracy.\"              8      Cape filed a civil antitrust action under 15 U.S.C. &#167; 15, a civil RICO action under 18 U.S.C. &#167; 1964(c), and various state claims against the defendants. The district court granted the defendants' motion to dismiss, finding that Cape had failed to state a claim upon which relief could be granted. The court dismissed the federal counts with prejudice, and the pendant state law claims without prejudice. Cape now appeals that ruling.        II. Discussion          A. Antitrust Claim              9      The district court dismissed Cape's antitrust claim because it found that Cape had not properly alleged an antitrust injury. The court noted that for a civil litigant to show antitrust injury, it must show injuries that reflect the anticompetitive effect of either the violation or the anticompetitive acts made possible by the violation. Brunswick Corp. v. Pueblo Bowl-O-Mat, Inc., 429 U.S. 477, 489, 97 S.Ct. 690, 50 L.Ed.2d 701 (1977). The court further elaborated that such injury must involve \"loss [that] comes from acts that reduce output or raise prices to consumers.\" Chi. Prof'l Sports Ltd. P'ship v. Nat'l Basketball Ass'n, 961 F.2d 667, 670 (7th Cir. 1992). The court believed that Cape had not shown such injury, because \"by undercutting James Cape &amp; Sons[, Defendants] actually provided lower bids to the consumer. That is, their bid-rigging activities actually increased, rather than restricted, competition, albeit in an illegal manner.\" The court noted that Cape's damages resulted only because its bids were higher than Defendants' bids.              10      We agree with the district court that consumer injury is not necessarily related to Cape's injury. While Cape may have been injured because, absent a conspiracy, the defendants might have inflated their prices in hopes of receiving more profit from the project and therefore not received the bid, the conspiracy still would have resulted in the consumer paying a price below Cape's bid. Such a loss would not \"come[ ] from acts that reduce output or raise prices to consumers.\" Chi. Prof'l Sports, 961 F.2d at 670.              11      On appeal, Cape argues that the district court overlooked one form of antitrust injury mentioned in the complaint. Cape claims that it properly alleged that Beaudoin, as a member of the conspiracy, not only shared Cape's bids with the rest of the defendants, but also falsely inflated Cape's bids to allow Streu and Vinton to win the project. Thus, the other defendants' \"undercutting\" did not necessarily result in lower prices for the state, Cape claims. Defendants respond that Cape did not raise any such allegation in the pleadings that were before the district court.              12      Cape believes that it did raise this theory in its pleadings below. First, Cape alleged that Beaudoin had the authority to prepare cost estimates that the company would use to prepare its bids.1 The rest of the theory, Cape submits, can be inferred from Cape's allegations that \"Defendants\" \"rigged\" bids. Cape argues that \"rigged,\" since it is used in reference to \"Defendants\" (which would include Beaudoin), should encompass the inflated estimate scheme alleged on appeal. The language in the complaint that best supports this theory is found in paragraph 85, wherein Cape alleges, \"[D]efendants [presumedly including Beaudoin] took various actions, including . . . designating which coconspirator [sic] would submit the low bid for the project and which of the co-conspirators [again, presumedly including Beaudoin] would submit higher, complementary bids for the project.\"              13      After reading the complaint, we conclude that the issue was not adequately plead to the district court. Most of the complaint alleges that Streu and Vinton unfairly underbid Cape, and mentions Beaudoin only in the context of accusing him of sharing information with the other defendants so as to allow them to adjust their bids.              14      Plaintiff's argument that it properly plead its theory that Beaudoin inflated Cape's bids merely by alleging that the \"defendants\" \"rigged\" bids is weakened by the way in which Cape uses the word \"defendants\" throughout its complaint. For example, almost immediately following paragraph 85 is an accusation that \"defendants\" \"[a]ccept[ed] payment from the State of Wisconsin.\" Including Beaudoin in this group of \"defendants\" is arguably inconsistent with Cape's own claim for damages. Throughout the complaint, Cape repeatedly refers to \"defendants\" allocating contracts amongst \"themselves,\" with the clear implication that only Streu and Vinton received the contracts and Cape was excluded. We believe it unfair to expect Defendants to completely ignore the context of the complaint and read the term \"defendants\" to mean \"defendants [including Beaudoin],\" as Cape encourages us to do in its brief, when throughout most of the complaint, the allegations make sense only if \"defendants\" is read to mean \"defendants [excluding Beaudoin].\"              15      Therefore, we hold that the district court had no basis from which to reasonably find that the claim that Beaudoin artificially raised Cape's bids was included in the complaint, and was justified in not considering it.              16      Cape argues that even if it did not properly allege its claim, the district court should have allowed it to amend its complaint before dismissing it with prejudice. Defendants counter that Cape never requested leave to amend its complaint. Cape arguably states its desire to amend its complaint, if necessary, in the next-to-last paragraph in its response to the defendants' motion to dismiss;2 however, neither the caption nor the conclusion of the motion formally requests leave to amend.              17      Under Federal Rule of Civil Procedure 15, leave to amend \"shall be freely given when justice so requires.\" Cape seems to argue that, even though it did not properly request leave to amend its complaint, the district court was required by Rule 15 to dismiss without prejudice and/or sua sponte grant leave to amend the complaint. It does not cite any case law to support this proposition. In Coates v. Illinois State Board of Education, 559 F.2d 445 (7th Cir.1977), the plaintiff made a Rule 15-based argument similar to the one Cape presses here. We ruled, \"We agree that [the district judge] correctly held the complaint insufficient. He did not abuse his discretion in denying leave to amend the complaint, because such leave was never sought. Under these circumstances, we can find no basis for disturbing his judgment in any way.\" Coates, 559 F.2d at 451 (citing Foman v. Davis, 371 U.S. 178, 182, 83 S.Ct. 227, 9 L.Ed.2d 222 (1962)) (footnote omitted).              18      Furthermore, the only time Cape even arguably requested leave to amend, in the penultimate paragraph of its response to defendants' motion to dismiss, it expressed its intention to \"describe in even greater detail the damages it suffered.\" The district court could have quite reasonably believed that an amended complaint would suffer the same fatal flaws as the one before it, and that the \"interests of justice\" did not require permission to amend. See FED. R. CIV. P. 15. District judges are not mind readers, and should not be required to explain to parties whether or how their complaints could be drafted to survive a motion to dismiss. Even assuming that Cape properly moved to amend, the district court did not abuse its discretion in dismissing with prejudice, since it had no way of knowing what the proposed amendment entailed.              19      Cape's final argument against dismissal of its antitrust claim is that it has stated a claim under our precedent in Hammes v. AAMCO Transmissions, Inc., 33 F.3d 774, 783 (7th Cir.1994). That case holds that antitrust damages may result if a cartel inflicts damage on one of its own members in retaliation for that member's attempt to undercut the cartel's prices and therefore lower consumer prices. Id. The heart of Cape's claim, however, is that it was never a member of the cartel in the first place, which is what allowed it to be underbid by the members of the conspiracy. The Hammes case is therefore inapplicable here.              20      For these reasons, we affirm the district court's dismissal of Cape's antitrust claim.              B. RICO Claim              21      Cape also protests the district court's dismissal of its civil RICO claim. The district court found that Cape had failed to allege that the defendants had managed or controlled WisDOT, thus creating an incomplete civil RICO claim under 18 U.S.C. &#167; 1964(c). In Reves v. Ernst &amp; Young, 507 U.S. 170, 178-79, 113 S.Ct. 1163, 122 L.Ed.2d 525 (1993), the Court clarified that in order to \"participate in the conduct\" of a criminal enterprise for the purposes of RICO liability, a defendant must exercise some role in the direction of the enterprise. See also Goren v. New Vision Int'l, Inc., 156 F.3d 721, 727 (7th Cir.1998) (\"[M]ere participation in the activities of the enterprise is insufficient; the defendant must participate in the operation or management of the enterprise.\").              22      Cape argues that it has alleged the requisite control because WisDOT awarded the projects by a computer program designed to accept the lowest bid; therefore the bid-rigging scheme effectively controlled a \"core function\" of WisDOT, selecting who would receive construction projects. Cape argues that this meets the control element of a civil RICO claim.              23      Cape relies principally on a recent case from the Middle District of Florida, Lockheed Martin Corp. v. Boeing Co., 357 F.Supp.2d 1350 (M.D.Fla.2005), in which the district court ruled that by creating its bid estimates based on Lockheed Martin's confidential information, which was stolen from an ex-Lockheed employee, Boeing had \"controlled\" the government's bid process within the meaning of the civil RICO statute.              24      The Lockheed Martin court relied in part on United States v. Castro, 89 F.3d 1443 (11th Cir.1996). In Castro, a group of lawyers paid a judge to assign them contract public defender cases. The Eleventh Circuit ruled that although the lawyers had no actual control over who received the public defender appointments, their kickbacks to the judge gave them sufficient \"control\" over the court that they could be held liable for RICO violations. The Lockheed Martin court analogized Boeing's scheme to Castro, stating:              25      [I]n this case, the Boeing defendants were not primarily responsible for determining which companies received . . . contracts. Yet, like the defendants in Castro, they are alleged to have engaged in illegal activity which substantially impacted the decisions of those who did have principal decision-making authority. The only difference in this case is that the decision-makers were neither aware of, nor complicit in, the alleged scheme. This is a distinction, however, that is irrelevant to the question of whether the Boeing Defendants controlled the alleged legitimate enterprise through their illegal conduct.              26      Lockheed Martin, 357 F.Supp.2d at 1359-60.              27      The district court rejected Cape's analogy to Lockheed Martin. Judge Griesbach wrote that he believed that the Lockheed Martin court had confused controlling the outcome of a given situation with controlling the enterprise itself. The court believed that the only affairs controlled here were the defendants' own. The district court stated that the defendants were basically cheaters, who had no more \"control\" over WisDOT than an illegal steroid user has over Major League Baseball. Although the district court acknowledged that an outsider can \"direct\" an organization through, for example, bribery, the district court found these situations distinguishable from the instant case&#8212;in bribery situations, the outsider directs the enterprise by proxy.              28      Cape attempts to refute this logic by relying on this court's analysis in United States v. Cummings, 395 F.3d 392 (7th Cir.2005). In that case, a \"skip tracer,\" or person employed by a credit agency to find debtors who can no longer be located, was accused of paying certain employees of the State of Illinois for confidential personal information available in a state database. We ruled that this bribery did not constitute the requisite control of the agency to maintain a RICO conviction, because the skip tracer \"did not pay bribes in order to exert control over [the agency's] core functions[.]\" Cummings, 395 F.3d at 399. Cape argues that the logical extension of this case is that Defendants exercised sufficient control over WisDOT to create a valid civil RICO claim, since they exercised control over the allocation of construction contracts, a \"core function\" of the agency.              29      This argument presents a classic logical fallacy. Cummings stands for the proposition that control over an agency requires control over one of the agency's \"core functions.\" In other words, control over an agency's core functions is necessary, but potentially insufficient, to create the appropriate level of control required for a RICO claim. In this case, Defendants controlled the outcome of WisDOT's bidding process, but not the manner in which the department went about awarding the contract. That is not enough for civil RICO purposes. If the defendants had bribed a WisDOT employee to override the computer's recommendation, or enter a false bid into the computer, they would have controlled the enterprise. That is not the case here. Cape has failed to demonstrate that the defendants controlled WisDOT for civil RICO purposes.              30      Even assuming that Cape had shown that defendants \"managed or controlled\" WisDOT, its claim would still fail because it has not properly alleged that the RICO violation was the proximate cause of its damages. The Supreme Court recently made clear that a civil RICO claim cannot survive unless the plaintiff properly alleges that the RICO violation was the proximate cause of his or her damages. Anza v. Ideal Steel Supply Corp., ___ U.S. ___, 126 S.Ct. 1991, L.Ed.2d ___, 2006 WL 1519365 (2006). In Anza, the plaintiff, Ideal Steel Supply Corp., alleged that the defendants' company, National, had not paid New York sales tax, which allowed National to unfairly undercut Ideal's prices. Anza, 126 S.Ct. at 1994. Plaintiff alleged that defendants committed mail fraud and wire fraud when they submitted false tax returns to the New York State Department of Taxation and Finance. Id. at 1995. The Second Circuit ruled that \"even where the [racketeering] scheme depended on fraudulent communications directed to and relied on by a third party rather than the plaintiff,\" the plaintiff has adequately plead proximate cause if the complaint alleges a pattern of racketeering activity \"that was intended to and did give the defendant a competitive advantage over the plaintiff\". Id. (citing Ideal Supply Corp. v. Anza, 373 F.3d 251 (2d Cir.2004)).              31      The Supreme Court disagreed, holding that the relevant inquiry to determine proximate cause is \"whether the alleged violation led directly to the plaintiff's injuries.\" Anza, 126 S.Ct. at 1998. The Court wrote, \"The RICO violation alleged by Ideal is that the Anzas conducted National's affairs through a pattern of mail fraud and wire fraud. The direct victim of the conduct was the State of New York, not Ideal. It was the state that was being defrauded and the State that lost tax revenue as a result.\" Id. at 1997. The Court explained that civil RICO plaintiffs must show that the alleged fraud directly harmed them, lest damages become too difficult to ascertain.              32      The injury Ideal alleges is its own loss of sales resulting from National's decreased prices for cash-paying customers. National, however, could have lowered its prices for any number of reasons unconnected to the asserted pattern of fraud. It may have received a cash inflow from some other source or concluded that the additional sales would justify a smaller profit margin. Its lowering of prices in no sense required it to defraud the state tax authority. Likewise, the fact that a company commits tax fraud does not mean the company will lower its prices; the additional cash could go anywhere from asset acquisition to research and development to dividend payouts.              33              Id.                    34      This case poses similar concerns. A court could never be certain whether Cape would have won any of the contracts that were the subject of the conspiracy \"for any number of reasons unconnected to the asserted pattern of fraud.\" See Anza, 126 S.Ct. at 1997. It is entirely possible that Defendants would have won some bids absent the bid-rigging scheme, even if making less profits in the meantime. Furthermore, Cape cannot show what portion of its \"lost market share\" is attributable to the bids lost to the bid-rigging scheme. As the Court stated in Anza, \"Businesses lose and gain customers for many reasons, and it would require a complex assessment to establish what portion of Ideal's lost sales were the product of National's decreased prices.... A RICO plaintiff cannot circumvent the proximate-cause requirement simply by claiming that the defendant's aim was to increase market share at a competitor's expense.\" Anza, 126 S.Ct. at 1997-98.              35      Also compelling is the Court's holding that a direct causal connection is \"especially warranted where the immediate victims of an alleged RICO violation can be expected to vindicate the laws by pursuing their own claims.\" Id. at 1998. Here, WisDOT is fully capable of pursuing appropriate remedies, much like the State of New York in Anza.              36      Therefore, both because Cape has not shown that Defendants \"managed or controlled\" WisDOT, and because it has not shown that its injuries were proximately caused by the bid-rigging scheme, we affirm the district court's dismissal of the civil RICO claim.        III. Conclusion          37      For the foregoing reasons, the judgment of the district court is AFFIRMED.                      Notes:                    1         This contention was not made as articulately in the pleadings, which alleged instead that Beaudoin \"as part of his job worked on estimates for some bids submitted to WisDOT.\"                    2         That paragraph reads, \"If there is any question as to the sufficiency of the allegations as to the federal and state claims (which Cape contends there is not), the claims certainly should not be dismissed with prejudice as defendants request. Cape should be afforded the opportunity to amend `its complaint so as to describe in even greater detail the damages it suffered as a result of defendants' Sherman Act violations and how another enterprise ... existed and was utilized by defendants to perpetrate their scheme.\"          """
    #return extractSentences(test, 0.5)

if __name__ == "__main__":
    main(sys.argv)
